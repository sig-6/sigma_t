<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | Team Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --level1: #00ffcc;
            --level2: #00d4ff;
            --level3: #9d4edd;
            --level4: #ff6b9d;
            --level5: #ffaa00;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1200px;
            height: 1200px;
            background: radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, transparent 70%);
            z-index: -2;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,255,204,0.3);
            z-index: 1001;
        }
        
        .connect-btn.connected {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 30px;
        }
        
        .header h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 10px;
            animation: rainbow 8s ease infinite;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .stat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-sub {
            font-size: 14px;
            color: #888;
        }
        
        .filters-container {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            margin-bottom: 30px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            color: #aaa;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-input, .filter-select {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 15px;
            color: var(--text);
            font-size: 14px;
        }
        
        .filter-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2300ffcc' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .main-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.15);
            position: relative;
        }
        
        .main-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid rgba(45,47,62,0.5);
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(0,255,204,0.1), rgba(157,78,221,0.1));
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(0,255,204,0.2);
        }
        
        td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(45,47,62,0.3);
            font-size: 14px;
        }
        
        tr:hover td { background: rgba(255,255,255,0.03); }
        
        .level-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }
        
        .level-1 { background: rgba(0,255,204,0.1); color: var(--level1); border: 1px solid rgba(0,255,204,0.3); }
        .level-2 { background: rgba(0,212,255,0.1); color: var(--level2); border: 1px solid rgba(0,212,255,0.3); }
        .level-3 { background: rgba(157,78,221,0.1); color: var(--level3); border: 1px solid rgba(157,78,221,0.3); }
        .level-4 { background: rgba(255,107,157,0.1); color: var(--level4); border: 1px solid rgba(255,107,157,0.3); }
        .level-5 { background: rgba(255,170,0,0.1); color: var(--level5); border: 1px solid rgba(255,170,0,0.3); }
        
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: rgba(255,255,255,0.03);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            display: inline-block;
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }
        
        .empty-state i { font-size: 48px; margin-bottom: 20px; color: var(--secondary); opacity: 0.5; }
        
        .results-count {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 10px 20px;
            border-radius: 12px;
            background: rgba(0,255,204,0.1);
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        .nav-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: #888;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .connect-btn {
                position: relative;
                top: auto;
                right: auto;
                margin: 0 auto 20px;
                width: 100%;
                justify-content: center;
            }
            .stats-container { grid-template-columns: 1fr; }
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gradient); border-radius: 4px; animation: rainbow 8s ease infinite; }
    </style>
</head>
<body>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <div class="container">
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
            <button class="nav-btn" onclick="loadTeamData()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="nav-btn" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
        </div>
        
        <div class="header">
            <h1>TEAM NETWORK</h1>
            <p>Complete Downline Analysis with Real SIG6 Balances</p>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-users"></i> Total Team Members</div>
                <div class="stat-value" id="total-members">0</div>
                <div class="stat-sub">Across 5 levels</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-sitemap"></i> Direct Referrals</div>
                <div class="stat-value" id="direct-referrals">0</div>
                <div class="stat-sub">Level 1 members</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-coins"></i> Team SIG6 Holdings</div>
                <div class="stat-value" id="team-sigma">0</div>
                <div class="stat-sub" id="team-sigma-usdt">$0.00 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-chart-line"></i> Current Rates</div>
                <div class="stat-value" id="buy-rate">0.0316 USDT</div>
                <div class="stat-sub" id="sell-rate">Sell: 0.0300 USDT</div>
            </div>
        </div>
        
        <div class="filters-container">
            <div class="filters-grid">
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-layer-group"></i> Level</div>
                    <select id="level-filter" class="filter-select">
                        <option value="all">All Levels</option>
                        <option value="1">Level 1 (Direct)</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-search"></i> Search</div>
                    <input type="text" id="search-address" class="filter-input" placeholder="Wallet address...">
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-toggle-on"></i> Status</div>
                    <select id="status-filter" class="filter-select">
                        <option value="all">All</option>
                        <option value="active">Active (≥10 USDT)</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> Apply</button>
                <button class="filter-btn btn-secondary" onclick="resetFilters()"><i class="fas fa-redo"></i> Reset</button>
            </div>
        </div>
        
        <div class="main-card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-sitemap"></i> DOWNLINE NETWORK</div>
                <div class="card-actions">
                    <button class="action-btn" onclick="sortTable('balance')"><i class="fas fa-sort-amount-down"></i> Balance</button>
                    <button class="action-btn" onclick="sortTable('date')"><i class="fas fa-sort-numeric-down"></i> Join Date</button>
                </div>
            </div>
            
            <div class="results-count" id="results-count" style="display: none;">
                <i class="fas fa-users"></i> <span id="results-text">0 members</span>
            </div>
            
            <div class="table-responsive">
                <table id="team-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Wallet Address</th>
                            <th>Level</th>
                            <th>SIG6 Balance</th>
                            <th>USDT Value</th>
                            <th>Join Date</th>
                            <th>Join Time</th>
                            <th>Upline</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="team-body">
                        <tr><td colspan="10" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Connect wallet to view team</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ===== CONTRACT CONFIGURATION =====
        const SIGMA_ADDR = "0xeA0a8150c5B368ec026ffB094FCfCdB3FaBFa479";
        const USDT_ADDR = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
        const CREATOR_WALLET = "0xb579377DDe2C03b2b46B5b12453F4dbAddB06f2E";
        
        // Minimal ABI for speed
        const SIGMA_SIX_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function upline(address) view returns (address)",
            "function buyRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "user", "type": "address"},
                    {"indexed": true, "name": "referrer", "type": "address"},
                    {"indexed": false, "name": "timestamp", "type": "uint256"}
                ],
                "name": "MemberJoined",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "from", "type": "address"},
                    {"indexed": true, "name": "to", "type": "address"},
                    {"indexed": false, "name": "value", "type": "uint256"}
                ],
                "name": "Transfer",
                "type": "event"
            }
        ];
        
        // State
        let provider, signer, userAddress, sigmaContract;
        let teamMembers = [];
        let filteredMembers = [];
        let buyRate = 0.0316, sellRate = 0.0300;
        let currentSort = { field: 'level', order: 'asc' };
        let isLoading = false;
        
        // Auto-connect
        window.onload = async () => {
            const lastConnected = localStorage.getItem('sigma_wallet_connected');
            if (lastConnected === 'true') {
                await checkConnection();
            }
        };
        
        async function checkConnection() {
            if (window.ethereum) {
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    const accounts = await provider.send("eth_accounts", []);
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (e) { 
                    console.error("Auto-connect error:", e);
                }
            }
        }
        
        async function connectWallet() {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                window.open("https://metamask.io/download/", "_blank");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                
                sigmaContract = new ethers.Contract(SIGMA_ADDR, SIGMA_SIX_ABI, provider);
                
                document.getElementById('btn-text').textContent = 
                    userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                localStorage.setItem('sigma_wallet_connected', 'true');
                
                await loadTeamData();
                
                window.ethereum.on('accountsChanged', async (accs) => {
                    if (accs.length > 0) {
                        userAddress = accs[0];
                        document.getElementById('btn-text').textContent = 
                            userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                        await loadTeamData();
                    } else {
                        document.getElementById('btn-text').textContent = 'Connect Wallet';
                        document.getElementById('connectBtn').classList.remove('connected');
                        localStorage.removeItem('sigma_wallet_connected');
                    }
                });
                
            } catch (error) {
                console.error("Connection error:", error);
                alert("Connection failed: " + error.message);
            }
        }
        
        // ===== MAIN LOAD FUNCTION WITH CORRECT ACTIVE CONDITION =====
        async function loadTeamData() {
            if (!userAddress || !sigmaContract || isLoading) return;
            
            isLoading = true;
            
            try {
                document.getElementById('team-body').innerHTML = `
                    <tr><td colspan="10" class="loading">
                        <i class="fas fa-spinner fa-spin"></i><br>
                        Loading team data...
                    </td></tr>
                `;
                
                // Get current rates - SELL RATE is important for active status
                try {
                    const [buyRateRaw, sellRateRaw] = await Promise.all([
                        sigmaContract.buyRate(),
                        sigmaContract.getSellRate()
                    ]);
                    buyRate = parseFloat(ethers.formatUnits(buyRateRaw, 6));
                    sellRate = parseFloat(ethers.formatUnits(sellRateRaw, 6));
                    
                    document.getElementById('buy-rate').textContent = buyRate.toFixed(4) + ' USDT';
                    document.getElementById('sell-rate').textContent = `Sell: ${sellRate.toFixed(4)} USDT`;
                } catch (e) {}
                
                // Calculate minimum SIG6 needed for ACTIVE status (10 USDT)
                const minSIG6ForActive = 10 / sellRate; // ~321.5 at 0.0311
                
                // Get MemberJoined events for join dates
                const memberFilter = sigmaContract.filters.MemberJoined();
                const memberEvents = await sigmaContract.queryFilter(memberFilter, 0, 'latest');
                
                const joinDateMap = new Map();
                for (const event of memberEvents) {
                    joinDateMap.set(event.args.user.toLowerCase(), Number(event.args.timestamp));
                }
                
                // Get Transfer events to find holders
                const transferFilter = sigmaContract.filters.Transfer();
                const transfers = await sigmaContract.queryFilter(transferFilter, 0, 'latest');
                
                // Collect unique addresses
                const addresses = new Set();
                for (let i = Math.max(0, transfers.length - 1000); i < transfers.length; i++) {
                    addresses.add(transfers[i].args.to.toLowerCase());
                }
                addresses.add(CREATOR_WALLET.toLowerCase());
                
                // Process in batches
                const addrArray = Array.from(addresses);
                teamMembers = [];
                
                for (let i = 0; i < addrArray.length; i += 50) {
                    const batch = addrArray.slice(i, i + 50);
                    const batchPromises = batch.map(async (addr) => {
                        if (addr === userAddress.toLowerCase() || addr === CREATOR_WALLET.toLowerCase()) return null;
                        
                        try {
                            const [balanceRaw, uplineAddr] = await Promise.all([
                                sigmaContract.balanceOf(addr),
                                sigmaContract.upline(addr)
                            ]);
                            
                            const balance = parseFloat(ethers.formatEther(balanceRaw));
                            if (balance <= 0) return null;
                            
                            // Find level
                            let level = 0;
                            if (uplineAddr && uplineAddr !== "0x0000000000000000000000000000000000000000") {
                                let currentAddr = uplineAddr.toLowerCase();
                                let currentLevel = 1;
                                
                                while (currentAddr && currentAddr !== "0x0000000000000000000000000000000000000000" && currentLevel <= 5) {
                                    if (currentAddr === userAddress.toLowerCase()) {
                                        level = currentLevel;
                                        break;
                                    }
                                    
                                    try {
                                        const nextUpline = await sigmaContract.upline(currentAddr);
                                        if (!nextUpline || nextUpline === "0x0000000000000000000000000000000000000000") break;
                                        currentAddr = nextUpline.toLowerCase();
                                        currentLevel++;
                                    } catch {
                                        break;
                                    }
                                }
                            }
                            
                            if (level > 0) {
                                const joinTimestamp = joinDateMap.get(addr) || 0;
                                
                                // ===== FIXED ACTIVE CONDITION =====
                                // Active only if SIG6 balance >= minimum required for 10 USDT
                                const isActive = balance >= minSIG6ForActive;
                                
                                return {
                                    address: addr,
                                    level: level,
                                    balance: balance,
                                    usdtValue: balance * sellRate, // Use SELL rate for value
                                    upline: uplineAddr ? uplineAddr.toLowerCase() : "0x0000000000000000000000000000000000000000",
                                    joinTime: joinTimestamp > 0 ? new Date(joinTimestamp * 1000) : null,
                                    joinTimestamp: joinTimestamp,
                                    isActive: isActive
                                };
                            }
                        } catch (e) {}
                        return null;
                    });
                    
                    const results = await Promise.all(batchPromises);
                    teamMembers.push(...results.filter(r => r !== null));
                }
                
                // Sort and display
                teamMembers.sort((a, b) => a.level - b.level);
                filteredMembers = [...teamMembers];
                
                updateStats();
                updateTeamTable();
                
            } catch (error) {
                console.error("Error loading team:", error);
                document.getElementById('team-body').innerHTML = `
                    <tr><td colspan="10" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error: ${error.message}
                    </td></tr>
                `;
            } finally {
                isLoading = false;
            }
        }
        
        function updateStats() {
            const total = teamMembers.length;
            const direct = teamMembers.filter(m => m.level === 1).length;
            const totalSigma = teamMembers.reduce((sum, m) => sum + m.balance, 0);
            const totalUsdt = teamMembers.reduce((sum, m) => sum + m.usdtValue, 0);
            
            document.getElementById('total-members').textContent = total;
            document.getElementById('direct-referrals').textContent = direct;
            document.getElementById('team-sigma').textContent = totalSigma.toFixed(2) + ' SIG6';
            document.getElementById('team-sigma-usdt').innerHTML = '$' + totalUsdt.toFixed(2) + ' USDT';
        }
        
        function updateTeamTable() {
            const tbody = document.getElementById('team-body');
            const resultsDiv = document.getElementById('results-count');
            const resultsText = document.getElementById('results-text');
            
            if (filteredMembers.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="10" class="empty-state">
                        <i class="fas fa-users-slash"></i><br>
                        No team members found in downline
                    </td></tr>
                `;
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Count active members for display
            const activeCount = filteredMembers.filter(m => m.isActive).length;
            
            resultsDiv.style.display = 'block';
            resultsText.textContent = `${filteredMembers.length} members found (${activeCount} active)`;
            
            let html = '';
            filteredMembers.forEach((member, i) => {
                const uplineShort = member.upline.slice(0,6) + '...' + member.upline.slice(-4);
                
                let dateDisplay = '—';
                let timeDisplay = '—';
                if (member.joinTimestamp > 0) {
                    dateDisplay = member.joinTime.toLocaleDateString('en-IN');
                    timeDisplay = member.joinTime.toLocaleTimeString('en-IN', {hour12: false});
                }
                
                html += `
                    <tr>
                        <td>${i+1}</td>
                        <td>
                            <span class="wallet-address">${member.address.slice(0,8)}...${member.address.slice(-6)}</span>
                            <div style="font-size:11px; margin-top:3px">
                                <i class="fas fa-copy" onclick="copyAddress('${member.address}')" style="cursor:pointer; margin-right:8px" title="Copy Address"></i>
                                <i class="fas fa-external-link-alt" onclick="viewOnExplorer('${member.address}')" style="cursor:pointer" title="View on Explorer"></i>
                            </div>
                        </td>
                        <td><span class="level-badge level-${member.level}">Level ${member.level}</span></td>
                        <td><span style="color:var(--primary); font-weight:700">${member.balance.toFixed(2)}</span></td>
                        <td>$${member.usdtValue.toFixed(2)}</td>
                        <td>${dateDisplay}</td>
                        <td style="color:#aaa">${timeDisplay}</td>
                        <td><span class="wallet-address" style="font-size:12px">${uplineShort}</span></td>
                        <td>
                            <span class="level-badge ${member.isActive ? 'level-1' : 'level-5'}" 
                                  style="min-width:70px">
                                ${member.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" style="padding:6px 12px" onclick="viewMember('${member.address}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function applyFilters() {
            const level = document.getElementById('level-filter').value;
            const search = document.getElementById('search-address').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            
            filteredMembers = teamMembers.filter(m => {
                if (level !== 'all' && m.level !== parseInt(level)) return false;
                if (search && !m.address.toLowerCase().includes(search)) return false;
                if (status === 'active' && !m.isActive) return false;
                if (status === 'inactive' && m.isActive) return false;
                return true;
            });
            
            sortData(filteredMembers);
            updateTeamTable();
        }
        
        function resetFilters() {
            document.getElementById('level-filter').value = 'all';
            document.getElementById('search-address').value = '';
            document.getElementById('status-filter').value = 'all';
            filteredMembers = [...teamMembers];
            sortData(filteredMembers);
            updateTeamTable();
        }
        
        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            sortData(filteredMembers);
            updateTeamTable();
        }
        
        function sortData(data) {
            data.sort((a, b) => {
                let comparison = 0;
                switch(currentSort.field) {
                    case 'balance':
                        comparison = b.balance - a.balance;
                        break;
                    case 'date':
                        if (a.joinTimestamp === 0 && b.joinTimestamp === 0) comparison = 0;
                        else if (a.joinTimestamp === 0) comparison = 1;
                        else if (b.joinTimestamp === 0) comparison = -1;
                        else comparison = b.joinTimestamp - a.joinTimestamp;
                        break;
                    default:
                        comparison = a.level - b.level;
                }
                return currentSort.order === 'asc' ? comparison : -comparison;
            });
        }
        
        function copyAddress(addr) { 
            navigator.clipboard.writeText(addr); 
            alert("Address copied to clipboard!");
        }
        
        function viewOnExplorer(addr) { 
            window.open(`https://polygonscan.com/address/${addr}`, '_blank'); 
        }
        
        function viewMember(addr) { 
            const member = teamMembers.find(m => m.address === addr);
            if (member) {
                alert(`Member: ${addr}\nLevel: ${member.level}\nBalance: ${member.balance.toFixed(2)} SIG6\nValue: $${member.usdtValue.toFixed(2)} USDT`);
            }
        }
        
        function exportData() {
            if (!teamMembers.length) return;
            
            let csv = "Level,Address,Balance (SIG6),USDT Value,Status,Upline\n";
            teamMembers.forEach(m => {
                csv += `${m.level},${m.address},${m.balance.toFixed(2)},${m.usdtValue.toFixed(2)},${m.isActive ? 'Active' : 'Inactive'},${m.upline}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sigma_team_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
